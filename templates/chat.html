<!DOCTYPE html>
<html>
<head>
    <title>–ß–∞—Ç | {{ username }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>–û–Ω–ª–∞–π–Ω ({{ active_users|length }})</h3>
            <ul id="users-list">
                {% for user in active_users %}
                <li onclick="selectUser('{{ user }}')">{{ user }}</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="chat-area">
            <h1>–ß–∞—Ç: {{ username }}</h1>
            <div id="chat-mode">–û–±—â–∏–π —á–∞—Ç</div>
            <div id="chat"></div>
            <input type="text" id="message" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const username = "{{ username }}";
        const ws = new WebSocket(`ws://${window.location.host}/ws/${username}`);
        let currentReceiver = null;
        
        function selectUser(user) {
            currentReceiver = user;
            document.getElementById("chat-mode").innerText = `–õ–∏—á–Ω–æ: ${user}`;
            document.getElementById("message").placeholder = `–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ${user}...`;
        }
        
        ws.onmessage = function(event) {
            document.getElementById("chat").innerHTML += `<p>${event.data}</p>`;
            document.getElementById("chat").scrollTop = 
                document.getElementById("chat").scrollHeight;
        };
        
        function sendMessage() {
            const input = document.getElementById("message");
            const message = input.value.trim();
            
            if (message) {
                if (currentReceiver) {
                    ws.send(`@${currentReceiver} ${message}`);
                } else {
                    ws.send(message);
                }
                input.value = "";
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById("message").addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
<script>
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function playNotificationSound() {
        const audio = new Audio('/static/notification.mp3');
        audio.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫", e));
    }

    // –ü–æ–∫–∞–∑ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message) {
        if (Notification.permission === "granted") {
            new Notification("–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", { body: message });
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    ws.onmessage = function(event) {
        const msg = event.data;
        
        if (msg.startsWith("!private!")) {
            // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
            const cleanMsg = msg.replace("!private!", "");
            document.getElementById("chat").innerHTML += 
                `<p class="private-msg">${cleanMsg}</p>`;
            
            playNotificationSound();
            showNotification(cleanMsg);
        } else {
            // –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById("chat").innerHTML += `<p>${msg}</p>`;
        }
        
        document.getElementById("chat").scrollTop = 
            document.getElementById("chat").scrollHeight;
    };

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
        if (window.Notification && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    });
</script>
<!-- –î–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<form id="file-form" enctype="multipart/form-data">
    <input type="file" id="file-input" style="display: none;">
    <button type="button" onclick="document.getElementById('file-input').click()">
        üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
    </button>
</form>

<script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('sender', username);
        formData.append('receiver', currentReceiver || 'all');
        
        try {
            const response = await fetch('/upload_file', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.status !== 'success') {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    ws.onmessage = function(event) {
        const msg = event.data;
        
        if (msg.startsWith("!file!")) {
            // –ü–æ–∫–∞–∑ —Ñ–∞–π–ª–∞
            const [sender, file_url] = msg.replace("!file!", "").split(":");
            const file_html = `
                <div class="file-message">
                    <p>üìÅ ${sender} –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª:</p>
                    <a href="${file_url}" target="_blank">${file_url.split('/').pop()}</a>
                </div>
            `;
            document.getElementById("chat").innerHTML += file_html;
        }
        // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    };
</script>
